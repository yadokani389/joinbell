# joinbell ゲーム募集Bot 仕様書

## 1. 概要

本 Bot は, Discord 上でゲーム募集を簡単に行うための Bot である.
募集メッセージへのリアクションを参加意思の表明とし,
一定人数に達したら自動で開始通知を行うことで,
手動での声掛けや調整の負担を軽減することを目的とする.

本 Bot は, Discord のメッセージおよびリアクションを唯一の状態として扱い,
永続的なデータ保存を行わない軽量な設計を採用する.

## 2. 募集の作成

### 2.1 作成方法

- ユーザーはスラッシュコマンドを実行することで募集を作成する
- コマンド実行後, Bot は指定されたチャンネルに募集メッセージを投稿する
- Bot は募集メッセージに参加用のリアクションを自動で付与する
- `mention_role` が未指定の場合, Bot は `{game_title}` の名前でロールを作成し,
  開始通知で使用するロールとして設定する（mentionable = true）

### 2.2 募集メッセージ

- 募集メッセージは Bot により投稿される
- 募集メッセージは自動削除されない
- メッセージ本文には以下を含める
  - 固定の案内文
  - 募集内容を定義する TOML 設定ブロック

例

````text
このメッセージに :raised_hand: をつけると {game} に参加できます
人数が揃ったら開始通知が送られます

```toml
game_title = "minecraft"
required_players = 3
mention_role = 12345
notify_on_reaction = true
auto_assign_role_on_reaction = true
```
````

## 3. 募集設定（TOML）

### 3.1 設定記述方法

- 募集メッセージ内に TOML 形式で設定を記述する
- Bot はメッセージ本文から TOML を読み取り, 動作を決定する
- 設定内容は外部に保存しない

### 3.2 設定項目

- `game_title`
  募集するゲーム名
- `required_players`
  開始に必要な人数
- `mention_role`
  開始時にメンションするロール
- `notify_on_reaction`
  リアクション追加時に参加通知メッセージを送信するかどうか
- `auto_assign_role_on_reaction`
  リアクション追加時に, `mention_role` を自動で付与するかどうか
  （`mention_role` 未指定で作成した場合のデフォルトは true）

## 4. 参加方法

- ユーザーは募集メッセージに付与された参加用リアクションを付けることで参加する
- リアクションを外すことで参加を取り消すことができる
- 参加者の管理はリアクションの状態を正とし, Bot は参加者リストを保持しない
- `auto_assign_role_on_reaction = true` の場合, リアクション追加時に
  `mention_role` を持っていなければ自動で付与する
- リアクションを外しても, 自動付与されたロールは外さない

## 5. 参加通知（任意機能）

### 5.1 動作条件

- 募集設定で `notify_on_reaction = true` が指定されている場合に有効

### 5.2 動作内容

- 対象リアクションが追加されるたびに, Bot は参加通知メッセージを送信する
- 通知内容は固定文言とし, 以下を含む
  - リアクションを追加したユーザー
  - ゲーム名

例

```text
{user} が {game} に参加しました
```

### 5.3 削除仕様

- 参加通知メッセージは送信時点で削除タスクを登録する
- 送信から 1 時間後に自動で削除される
- リアクションが後から削除されても, 送信済みの参加通知は削除されない

## 6. 開始条件

- 募集メッセージに付与された参加用リアクションの数が,
  - 設定された開始人数に到達した瞬間を開始条件とする

## 7. 開始通知の送信条件

### 7.1 基本ルール

- 開始通知は, リアクション数が
  **「開始人数未満 → 開始人数以上」**
  になった瞬間にのみ送信される

### 7.2 送信されないケース

- すでに開始人数以上の状態でリアクション数が増加した場合
- 開始人数以上の状態が維持されている場合

### 7.3 再送信されるケース

- 一度リアクション数が開始人数未満に減少し,
- その後, 再び開始人数に到達した場合

この仕様により, 開始通知は
「人数がちょうど揃った瞬間」を表すイベントとして扱われる.

## 8. 開始通知メッセージ

### 8.1 内容

開始通知メッセージには以下を含める.

- 設定されたロールへのメンション
- 募集メッセージにリアクションしている全ユーザーへのメンション
- ゲーム名

例

```text
@role
@user1 @user2 が {game} を開始します
```

### 8.2 削除仕様

- 開始通知メッセージは送信時点で削除タスクを登録する
- 送信から 1 時間後に自動で削除される

## 9. 開始後の処理

- 開始通知メッセージ送信から 1 時間後に以下を行う
  - 開始通知メッセージを削除する
  - 募集メッセージに付与された参加用リアクションを削除する

- 募集メッセージ自体は削除しない

## 10. 同時募集

- 複数の募集を同時に行うことができる
- 各募集は独立して扱われる
- 募集ごとにスラッシュコマンドを実行して作成する

## 11. データ管理方針

- 永続的なデータ保存は行わない
- Bot は参加者リストや募集状態を保持しない
- Bot の判断は Discord 上のメッセージおよびリアクション状態に基づいて行う
